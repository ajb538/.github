name: AI Code Review (reusable)

on:
  workflow_call:
    inputs:
      repo:
        description: "Repository in owner/repo format"
        required: true
        type: string
      pr_number:
        description: "Pull request number"
        required: true
        type: number
    secrets:
      ORCHESTRATOR_URL:
        required: true
      TS_AUTHKEY:
        required: true
    outputs:
      review-text:
        description: "AI code review output"
        value: ${{ jobs.review.outputs.review-text }}

jobs:
  review:
    runs-on: ubuntu-latest
    outputs:
      review-text: ${{ steps.orchestrator.outputs.review-text }}
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v3
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}
          tags: tag:ci

      - name: Call orchestrator
        id: orchestrator
        uses: actions/github-script@v7
        with:
          script: |
            const orchestratorUrl = '${{ secrets.ORCHESTRATOR_URL }}';
            const repo = '${{ inputs.repo }}';
            const prNumber = ${{ inputs.pr_number }};

            async function callMcpTool(toolName, args) {
              const resp = await fetch(`${orchestratorUrl}/mcp`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Accept': 'application/json, text/event-stream',
                },
                body: JSON.stringify({
                  jsonrpc: '2.0',
                  id: 1,
                  method: 'tools/call',
                  params: { name: toolName, arguments: args },
                }),
              });
              if (!resp.ok) {
                throw new Error(`MCP HTTP ${resp.status}: ${await resp.text()}`);
              }
              const text = await resp.text();
              const match = text.match(/^data: (.+)$/m);
              if (!match) throw new Error(`Unexpected MCP response: ${text.slice(0, 200)}`);
              const data = JSON.parse(match[1]);
              if (data.error) throw new Error(`MCP error: ${JSON.stringify(data.error)}`);
              return data.result.content[0].text;
            }

            core.info(`Fetching PR context for ${repo}#${prNumber}...`);
            const contextResult = await callMcpTool('fetch_pr_context', {
              repo,
              pr_number: prNumber,
            });
            core.info(contextResult);

            core.info('Delegating code review...');
            const prPrefix = `pr-${prNumber}`;
            const reviewResult = await callMcpTool('delegate_task', {
              prompt: 'Review this pull request. Identify bugs, security issues, and significant code quality problems. Be concise and actionable.',
              context_files: [`${prPrefix}/description.md`, `${prPrefix}/diff.txt`],
              task_type: 'code-review',
              check_availability: true,
            });
            core.info('Review complete.');
            core.setOutput('review-text', reviewResult);
